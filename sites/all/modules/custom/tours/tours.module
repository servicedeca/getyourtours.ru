<?php
/**
 * @file
 */


/**
 * Implements hook_menu().
 */
function tours_menu() {
  $item['show_tours'] = array(
    'title' => 'Tours',
    'page callback' => 'tours_get_tours',
    'access callback' => TRUE,
  );
  $item['tours/autocomplete'] = array(
    'title' => 'Autocomplete',
    'page callback' => 'tours_autocomplete',
    'access callback' => TRUE,
  );
  $item['tours/autocomplete_to'] = array(
    'title' => 'Autocomplete',
    'page callback' => 'tours_autocomplete_to',
    'access callback' => TRUE,
  );
  $item['tours/search_tours'] = array(
    'title' => 'Search tour',
    'page callback' => 'tours_search_tours',
    'access callback' => TRUE,
  );
  $item['tours/hotel/'] = array(
    'title' => 'Hotel',
    'page callback' => 'tours_hotel_tours',
    //'page arguments' => array(3),
    'access callback' => TRUE,
  );
  return $item;
}

/**
 * Implements hook_menu().
 */

function tours_theme() {

  $items['tours_search_form'] = array(
      'template' => 'tours_search_form',
      'render element' => 'form',
    );

  return $items;
}

/**
 * Form builder for tour search form.
 */
function tours_tour_search_form($form, $form_state) {

  $form['city'] = array(
    '#type'	=> 'textfield',
    '#title' => t('City â€‹â€‹of departure'),
    '#default_value' => $_GET['city'],
    '#attributes' => array(
      'class' => array('form-control'),
    ),
    '#autocomplete_path' => 'tours/autocomplete',
  );

  $form['country_to'] = array(
    '#type'	=> 'textfield',
    '#title' => t('Country to'),
    '#default_value' => $_GET['country_to'],
    '#attributes' => array(
      'class' => array('form-control'),
    ),
    '#autocomplete_path' => 'tours/autocomplete_to',
  );

  $form['date_of'] = array(
    '#type' => 'date_popup',
    '#title' => t('Date of'),
    '#date_format' => 'd.m.Y',
    '#attributes' => array(
      'class' => array('form-control'),
    ),
    '#default_value' => $_GET['date_of']['date'],
  );

  $form['date_to'] = array(
    '#type' => 'date_popup',
    '#title' => t('Date to'),
    '#date_format' => 'd.m.Y',
    '#attributes' => array(
      'class' => array('form-control'),
    ),
    '#default_value' => $_GET['date_of']['date'],
  );

  $options = array('none' => '<none>');

  $form['Accommodation'] = array(
    '#type' => 'select',
    '#title' => t('Accommodation'),
    '#attributes' => array(
      'class' => array('form-control'),
    ),
    '#options' => $options,
  );

  $form['search'] = array(
    '#type' => 'submit',
    '#value' => t('Search'),
    '#attributes' => array(
      'class' => array('btn btn-default'),
    ),
  );

  $form['#method'][] = 'GET';
  $form['#theme'][] = 'tours_search_form';
  return $form;
}

/*
 *  Get data from the operator
 */

function tours_get_data_operator() {
  $url = 'http://search.tez-tour.com/toursearch/references';
  $data = array(
    'locale' => 'ru',
    'formatResult' => 'true',
    'xml' => 'false',
  );
  $full_url = url($url, array('query' => $data));
  $result = drupal_http_request($full_url);
  $result = json_decode($result->data);

  return $result;
}

/**
 * Autocomplete callback.
 */
function tours_autocomplete($string) {
  $result = tours_get_data_operator();
  $data = $result->cities;
  $matches = array();
  if($string) {
    foreach($data as $key => $value){
      if(preg_match("/$string/i", $value->name)) {
        $matches[$value->name] = $value->name;
      }
    }
  }
  drupal_json_output($matches);
}

/**
 * Autocomplete_to callback.
 */
function tours_autocomplete_to($string) {
  $result = tours_get_data_operator();
  $data = $result->countries;
  $matches = array();
  if($string) {
    foreach($data as $key => $value){
      if(preg_match("/$string/i", $value->name)) {
        $matches[$value->name] = $value->name;
      }
    }
  }
  drupal_json_output($matches);
}

/*
 * Page callback tours/hotel
 */

function tours_hotel_tours() {
  $a = 1;
  var_dump(tours_get_tours(2));
}

/*
 * Page callback tours/show_tours.
 */
function tours_get_tours($hotelId) {

  if($_GET['city'] && !empty($_GET['city']) ) {
    $cities = tours_get_data_operator()->cities;
    $countries = tours_get_data_operator()->countries;
    foreach($cities as $value) {
      if($value->name == $_GET['city']) {
        $cityId = $value->cityId;
      }
    }
    foreach($countries as $value) {
      if($value->name == $_GET['country_to']) {
        $countryId = $value->countryId;
      }
    }
    $data_directory = array(
      'xml' => 'false',
      'formatResult' => 'true'
    );
    $directory_url = 'http://search.tez-tour.com/toursearch/getCalcTypes';
    $url = url($directory_url, array('query' => $data_directory));
    $directory = drupal_http_request($url);
    $directory = json_decode($directory->data)->calcByTariffs;
    foreach($directory as $value) {
      if($value->arrCountry == $countryId && $value->depCity == $cityId ){
        $dynamics = 1;
      }
    }
    $after = $_GET['date_of']['date'];
    $before = $_GET['date_to']['date'];
    if($dynamics == 1){
      $url = 'http://www.tez-tour.com/tariffsearch/getResult';
    }
    else{
      $url = 'http://www.tez-tour.com/toursearch/getResult';
    }
    $data = array(
      'priceMin' => '0',
      'priceMax' => '15000',
      'currency' => '5561',
      'nightsMin' => '6',
      'nightsMax' => '14',
      'hotelClassId' => '2567',
      'accommodationId' => '1',
      'rAndBId' => '15350',
      'tourType' => '1',
      'locale' => 'ru',
      'cityId' => $cityId,
      'countryId' => $countryId,
      'after' => $after,
      'before' => $before,
      'hotelInStop' => 'false',
      'specialInStop' => 'false',
      'version' => '2',
      'hotelClassBetter' => 'true',
      'rAndBBetter' => 'true',
      'hotelId' => $hotelId,
      'noTicketsTo' => 'false',
      'noTicketsFrom' => 'false',
      'searchTypeId' => '3',
      'recommendedFlag' => 'false',
      'salePrivateFlag' => 'false',
      'onlineConfirmFlag' => 'false',
    );
    $full_url = url($url, array('query' => $data));
    $result = drupal_http_request($full_url);
    return array(
     'tours' => json_decode($result->data)->data,
     'dynamics' => $dynamics,
    );
  }
  return false;
}